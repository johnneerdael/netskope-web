<!DOCTYPE html>
<html lang="map[author:map[bio:Engineer // Melbourne // Australia name:Nathan Catania photo:map[url:avatar.png]] contenttypename:posts dateform:Jan 2, 2006 dateformnum:2006-01-02 dateformnumtime:2006-01-02 15:04 &#43;1000 dateformshort:Jan 2 description:The official website of Nathan Catania &amp;#10003; disablereadotherposts:false enablethemetoggle:true giturl:https://github.com/nathancatania/website/commit/ homesubtitle:Engineer // Melbourne // Australia images:[] keywords:blog, website, official logo:map[logohomelink:/ logotext:$ cd /home/nathan] readotherposts:Read other posts social:[map[name:linkedin url:https://www.linkedin.com/in/nathancatania]] subtitle:Engineer // Melbourne // Australia]">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Engineer // Melbourne // Australia Nathan Catania map[url:avatar.png] ">
<meta name="description" content="These notes will cover how to integrate ZIA with Microsoft Cloud App Security (MCAS) - and vice-versa." />
<meta name="keywords" content="blog, website, official, mcas, zscaler, zia, lab, notes" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://nathancatania.com/posts/integrate-zia-and-mcas/" />


    <title>
        
            Integrate Zscaler with Microsoft Cloud App Security (MCAS) :: Nathan Catania  — Engineer // Melbourne // Australia
        
    </title>





<link rel="stylesheet" href="/main.b851fae37ea32930b5c4996a9ac8737a9d1ab1b40af28b3cd3b0060df9e2f5a3.css" integrity="sha256-uFH6436jKTC1xJlqmshzep0asbQK8os807AGDfni9aM=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Integrate Zscaler with Microsoft Cloud App Security (MCAS)">
<meta itemprop="description" content="These notes will cover how to integrate ZIA with Microsoft Cloud App Security (MCAS) - and vice-versa."><meta itemprop="datePublished" content="2020-07-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-07-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="2225"><meta itemprop="image" content="https://nathancatania.com" />
<meta itemprop="keywords" content="mcas,zscaler,zia,lab,notes," />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://nathancatania.com" /><meta name="twitter:title" content="Integrate Zscaler with Microsoft Cloud App Security (MCAS)"/>
<meta name="twitter:description" content="These notes will cover how to integrate ZIA with Microsoft Cloud App Security (MCAS) - and vice-versa."/>



    <meta property="og:title" content="Integrate Zscaler with Microsoft Cloud App Security (MCAS)" />
<meta property="og:description" content="These notes will cover how to integrate ZIA with Microsoft Cloud App Security (MCAS) - and vice-versa." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nathancatania.com/posts/integrate-zia-and-mcas/" /><meta property="og:image" content="https://nathancatania.com" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-02T00:00:00+00:00" />







    <meta property="article:published_time" content="2020-07-02 00:00:00 &#43;0000 UTC" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                $ cd /home/nathan</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/posts">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>11 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://nathancatania.com/posts/integrate-zia-and-mcas/">Integrate Zscaler with Microsoft Cloud App Security (MCAS)</a>
            </h1>
                <hr />
                <aside id="toc">
                <div class="toc-title">Table of Contents</div>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#requirements">Requirements</a>
      <ul>
        <li><a href="#1-zscaler-nss">1. Zscaler NSS</a></li>
        <li><a href="#2-zscaler-mcas-nss-feed">2. Zscaler MCAS NSS Feed</a>
          <ul>
            <li><a href="#add-a-new-mcas-nss-feed">Add a New MCAS NSS Feed</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#configure-mcas">Configure MCAS</a>
      <ul>
        <li><a href="#access-the-mcas-portal">Access the MCAS Portal</a></li>
        <li><a href="#generate-an-mcas-api-token">Generate an MCAS API Token</a></li>
        <li><a href="#configure-an-unsanctioned-app">Configure an Unsanctioned App</a></li>
        <li><a href="#add-zscaler-nss-as-a-data-source">Add Zscaler NSS as a Data Source</a></li>
      </ul>
    </li>
    <li><a href="#configure-zscaler-zia">Configure Zscaler (ZIA)</a>
      <ul>
        <li><a href="#provide-the-mcas-api-token">Provide the MCAS API Token</a></li>
        <li><a href="#optional-block-or-caution-access-to-unsanctioned-apps">(Optional) Block (or Caution) Access to unsanctioned apps</a></li>
      </ul>
    </li>
    <li><a href="#configure-the-zscaler-nss-server-vm">Configure the Zscaler NSS Server VM</a>
      <ul>
        <li><a href="#add-your-mcas-api-token-and-domain-to-nss">Add your MCAS API Token and Domain to NSS</a></li>
        <li><a href="#verify-logs-are-being-streamed-from-nss">Verify Logs are being streamed from NSS</a></li>
        <li><a href="#verify-logs-are-being-received-by-mcas">Verify logs are being received by MCAS</a></li>
      </ul>
    </li>
    <li><a href="#finish">Finish</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#verify-network-connectivity-to-mcas">Verify Network Connectivity to MCAS</a></li>
        <li><a href="#verify-your-api-token-and-domain-are-correct">Verify your API token and domain are correct</a></li>
        <li><a href="#verify-your-api-token-and-mcas-domain-were-entered-correctly-in-the-nss-vm">Verify your API token and MCAS domain were entered correctly in the NSS VM</a></li>
        <li><a href="#restart-the-nss-service">Restart the NSS Service</a></li>
        <li><a href="#turn-on-debug-logging">Turn on DEBUG logging</a></li>
        <li><a href="#check-the-mcas-data-source-is-correctly-named">Check the MCAS data source is correctly named</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </aside>
                <hr />

            
                <img src="banner.png" class="post-cover" />
            

            <div class="post-content">
                <p>Microsoft Cloud App Security (MCAS) is Microsoft&rsquo;s CASB product. We can integrate this with Zscaler Internet Access (ZIA) - and vice-versa.</p>
<p>ZIA will be able to pull data from MCAS under the Cloud Applications dashboard, and MCAS will be able to push custom URL categories to your ZIA tenant for your specified sanctioned/unsanctioned applications - which you can then configure allow/coach/block rules for Zscaler to enforce as required.</p>
<p>You must have a subscription for both MCAS and Zscaler&rsquo;s Nanolog Streaming Service (NSS) to be able to integrate the two products.</p>
<h1 id="requirements">Requirements</h1>
<h2 id="1-zscaler-nss">1. Zscaler NSS</h2>
<p>To stream Zscaler logs to MCAS, you will need to have deployed and configured Zscaler&rsquo;s Nanolog Streaming Service (NSS) in the ZIA admin portal - this allows you to stream logs from their logging clusters (called Nanolog) towards a SIEM or product of your choice (in this case, MCAS).</p>
<p>You can deploy the VM for NSS on-prem (available as an OVA image) or in AWS or Azure (Azure is strongly recommended).</p>
<p>For deployment in Azure, you can <a href="/posts/deploy-zscaler-nss-in-azure/">review my guide here</a>.</p>
<p>Zscaler documentation is available for <a href="https://help.zscaler.com/zia/nss-deployment-guide-vmware-vsphere">VMware</a> and <a href="https://help.zscaler.com/zia/nss-deployment-guide-amazon-web-services">AWS</a>.</p>
<p>Your NSS VM must have a state of <strong>Healthy</strong> to be able to integrate with MCAS.</p>
<p><img src="0.png" alt="0"></p>
<p>NB: Your NSS VM must have at least 8GB of memory for MCAS integration. If you&rsquo;re running a 4GB instance as a demo/lab NSS VM, this will not work and you&rsquo;ll need to deploy another instance with at 8GB assigned.</p>
<h2 id="2-zscaler-mcas-nss-feed">2. Zscaler MCAS NSS Feed</h2>
<p>Once you have deployed Zscaler NSS above, you&rsquo;ll also need to have an MCAS Feed configured before you can properly integrate with MCAS.</p>
<p>An NSS feed specifies the data you wish to stream from Nanolog: You can stream everything, or filter the data to only receive what you care about (security events, information relating to a specific user, etc).</p>
<p>An MCAS NSS Feed, is an NSS Feed specifically pre-formatted for ingestion into MCAS.</p>
<h3 id="add-a-new-mcas-nss-feed">Add a New MCAS NSS Feed</h3>
<p>In your ZIA portal, navigate to <strong>Administration &gt; Nanolog Streaming Service</strong>.</p>
<p><img src="1.png" alt="1"></p>
<p>Select the <strong>NSS Feeds</strong> tab, then select <strong>Add MCAS NSS Feed</strong>.</p>
<p><img src="2.png" alt="2"></p>
<p>Give the feed a name, select the NSS Server / VM instance that is associated with streaming this feed, and make sure you set the feed to <strong>Enabled</strong>. You can optionally define filters for the feed at the bottom of the panel. By default, EVERYTHING will be streamed to MCAS.</p>
<p><img src="3.png" alt="3"></p>
<p>When you are done, click <strong>Save</strong>, then <strong>Activate</strong> your changes. This will apply the feed to the NSS VM you selected.</p>
<h1 id="configure-mcas">Configure MCAS</h1>
<p>In this section, we&rsquo;ll focus on the MCAS specific config, including:</p>
<ul>
<li>Generating an API token</li>
<li>Setting at least 1 app as unsanctioned</li>
<li>Adding NSS as a data source</li>
</ul>
<h2 id="access-the-mcas-portal">Access the MCAS Portal</h2>
<p>You can access your MCAS Dashboard at the following link:
<a href="https://portal.cloudappsecurity.com/">https://portal.cloudappsecurity.com/</a></p>
<p>Alternatively, you access MCAS via the <a href="https://security.microsoft.com/">Microsoft 365 Admin Center</a>, under Security &gt; More Resources &gt; Cloud App Security.</p>
<h2 id="generate-an-mcas-api-token">Generate an MCAS API Token</h2>
<p>From the MCAS dashboard, click the <strong>Settings</strong> icon at the top right, and select <strong>Security extensions</strong>.</p>
<p><img src="4.png" alt="4"></p>
<p>On the <strong>API tokens</strong> tab, click the + icon to create a new token.</p>
<p><img src="5.png" alt="5"></p>
<p>Give the token a name (eg: <code>Zscaler Integration</code>) and click <strong>Generate</strong>.</p>
<p><strong>Note down both the API token and URL</strong> on screen as you will need these later! After you close this window, the token will NOT be shown again.</p>
<h2 id="configure-an-unsanctioned-app">Configure an Unsanctioned App</h2>
<p>To verify that the integration is working correctly, you must <a href="https://docs.microsoft.com/en-us/cloud-app-security/governance-discovery">configure at least one unsanctioned application</a>.</p>
<p>In the MCAS portal, navigate to <strong>Discover &gt; Cloud app catalog</strong>. Search for an application, then under <strong>Actions</strong>, click the three dots and select <strong>Unsanctioned</strong>.</p>
<p><img src="6.png" alt="6"></p>
<p>Apps that you set as unsanctioned will be pushed to Zscaler every 2 hours.</p>
<h2 id="add-zscaler-nss-as-a-data-source">Add Zscaler NSS as a Data Source</h2>
<p>You must <a href="https://docs.microsoft.com/en-us/cloud-app-security/zscaler-integration">explicitly configure MCAS</a> to accept logs from NSS by adding NSS as a Data Source within the MCAS portal.</p>
<p>From the MCAS dashboard, click the <strong>Settings</strong> icon at the top right, and select <strong>Log collectors</strong>.</p>
<p><img src="7.png" alt="7"></p>
<p>Make sure <strong>Automatic log upload</strong> is selected in the sidebar and that you are on the <strong>Data sources</strong> tab.</p>
<p>Click <strong>Add data source&hellip;</strong></p>
<p><img src="8.png" alt="8"></p>
<p>Enter the following information:</p>
<ul>
<li>Name = <strong>NSS</strong></li>
<li>Source = <strong>Zscaler - QRadar LEEF</strong></li>
<li>Receiver type = <strong>Syslog - UDP</strong></li>
</ul>
<p>Note: These three fields must be EXACTLY as the above - including the name. <strong>If the data source name is anything other than <strong><code>NSS</code></strong>, MCAS will not receive the log data from NSS.</strong></p>
<p><img src="9.png" alt="9"></p>
<p>Optionally set a comment, and click <strong>Add</strong>.</p>
<h1 id="configure-zscaler-zia">Configure Zscaler (ZIA)</h1>
<p>In this section, we&rsquo;ll configure MCAS integration on the Zscaler side by adding the MCAS API token to the ZIA admin portal, and (optionally) configure a URL filtering policy to block the MCAS unsanctioned apps.</p>
<h2 id="provide-the-mcas-api-token">Provide the MCAS API Token</h2>
<p>Navigate to <strong>Administration &gt; Partner Integrations</strong>.</p>
<p><img src="10.png" alt="10"></p>
<p>Under the <strong>Microsoft Cloud App Security</strong> tab, <strong>paste in your MCAS API Token</strong> in the area provided and click <strong>Test</strong>.</p>
<p><img src="11.png" alt="11"></p>
<p>This will validate your token, and if correct, will begin synchronization with MCAS.</p>
<p>If you receive an error, make sure you&rsquo;ve configured at least one application as unsanctioned (as per the above).</p>
<h2 id="optional-block-or-caution-access-to-unsanctioned-apps">(Optional) Block (or Caution) Access to unsanctioned apps</h2>
<p>Unsanctioned apps synchronized from MCAS are put into a custom URL category called <strong>MCAS Unsanctioned Apps</strong>. Block or caution on access to these by creating a URL Filtering Policy.</p>
<p>Navigate to <strong>Policy &gt; URL &amp; Cloud App Control</strong>.</p>
<p><img src="12.png" alt="12"></p>
<p>Click <strong>Add URL Filtering Policy</strong> and under the <strong>URL Categories</strong> dropdown, search for and select <strong>MCAS Unsanctioned Apps</strong>.</p>
<p><img src="13.png" alt="13"></p>
<p>Target this policy to specific users/groups/departments/locations as needed, and select an appropriate action (Allow, Caution, or Block). Click <strong>Save</strong> when finished and activate your changes.</p>
<p>Wait a moment, then attempt to visit one of the apps you marked in MCAS as unsanctioned.</p>
<p>In this example, Reddit was marked as unsanctioned and configured with a Caution action in the URL Filtering Policy. Attempting to access Reddit as a user going through ZIA now results in the following:</p>
<p><img src="14.png" alt="14"></p>
<p>If you your block does not apply, check that you have SSL Inspection enabled and that you aren&rsquo;t accidentally bypassing/exempting the site. If you can see the Zscaler Root CA and Intermediate Root CA when examining the certificate of the site, then SSL inspection is working as intended.</p>
<p><img src="15.png" alt="15"></p>
<h1 id="configure-the-zscaler-nss-server-vm">Configure the Zscaler NSS Server VM</h1>
<p>The last bit of config we need to do is to explicitly configure the NSS VM for MCAS by providing it with the MCAS API token. This will allow the NSS VM to make a connection to your MCAS tenant and forward logs.</p>
<h2 id="add-your-mcas-api-token-and-domain-to-nss">Add your MCAS API Token and Domain to NSS</h2>
<p>Log into your NSS VM. In my case, I&rsquo;ll SSH to it:</p>
<pre tabindex="0"><code>ssh zsroot@&lt;ip-of-nss-vm&gt;

Last login: Mon Jun 29 11:21:27 2020 from 10.0.88.4
ZscalerOS 10-R (SMKERNEL) #124: Fri Nov  2 17:44:46 PDT 2018
[zsroot@NSS ~]$ 
</code></pre><p>Run the <code>configure-mcas</code> command, and paste in your MCAS API token and MCAS domain when prompted:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ sudo nss configure-mcas

token (Authentication token for uploading to MCAS) []:
domain (MCAS domain like mycompany.portal.cloudappsecurity.com) []:
</code></pre><p><strong>DO NOT</strong> enter the full MCAS URL - enter the domain part only. For example, if your URL is <code>https://company.us3.portal.cloudappsecurity.com/</code>, drop the <code>https://</code> and trailing <code>/</code> and simply enter <code>company.us3.portal.cloudappsecurity.com</code></p>
<p>If you enter the full URL, the connection to MCAS will fail.</p>
<p>Restart the NSS service when you are finished:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ sudo nss restart
</code></pre><h2 id="verify-logs-are-being-streamed-from-nss">Verify Logs are being streamed from NSS</h2>
<p>You can monitor  <code>/sc/log/zbridge.log</code> file to ensure logs are being streamed to NSS. Log upload will occur every hour (note the multiple uploads and timestamps in the output below):</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ tail -f /sc/log/zbridge.log

[...snip... after starting the nss service...]
[2020-07-03 13:01:22] INFO Initialize MCAS handler
[2020-07-03 13:01:22] INFO Creating MCAS workers
[2020-07-03 13:01:22] INFO Created Worker 1
[2020-07-03 14:01:39] INFO Check and upload. queue size=1380
[2020-07-03 14:01:39] INFO Initiate Upload
[2020-07-03 14:01:47] INFO Initiate Response: OK
[2020-07-03 14:01:47] INFO Return url=https://prod5usw2console1.blob.core.windows.net/discovery-logs/[REDACTED]
[2020-07-03 14:01:47] INFO Perform Upload. Payload size=24632 queue size=1380
[2020-07-03 14:01:48] INFO Upload Response: Created
[2020-07-03 14:01:48] INFO Finalize Upload
[2020-07-03 14:01:50] INFO Finalize Response: OK
[2020-07-03 15:02:07] INFO Check and upload. queue size=778
[2020-07-03 15:02:07] INFO Initiate Upload
[2020-07-03 15:02:11] INFO Initiate Response: OK
[2020-07-03 15:02:11] INFO Return url=https://prod5usw2console1.blob.core.windows.net/discovery-logs/[REDACTED]
[2020-07-03 15:02:11] INFO Perform Upload. Payload size=13611 queue size=778
[2020-07-03 15:02:12] INFO Upload Response: Created
[2020-07-03 15:02:12] INFO Finalize Upload
[2020-07-03 15:02:13] INFO Finalize Response: OK
</code></pre><p>You can also check whether the NSS VM is aware of the MCAS feed you configured in ZIA by running the <code>nss troubleshoot feeds</code> command:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ sudo nss troubleshoot feeds

NSS is live 
Currently active feeds: 1
Feed name: NSS:
  Connection Status:
	[127.0.0.1:54493 -&gt; 127.0.0.1:13010] : Stable
  Other health checks:
	Feed is stable. No suspicious events detected.
</code></pre><p>This command can take several minutes to complete, so be patient.</p>
<h2 id="verify-logs-are-being-received-by-mcas">Verify logs are being received by MCAS</h2>
<p>In the MCAS Portal, check the Data Source you configured above (Settings &gt; Log collectors). After some time, you should see the <strong>Uploaded logs</strong> field increment:</p>
<p><img src="16.png" alt="16"></p>
<h1 id="finish">Finish</h1>
<p>You have now integrated Zscaler ZIA with Microsoft Cloud App Security!</p>
<p>Having issues with logs not appearing in MCAS? Read on&hellip;</p>
<h1 id="troubleshooting">Troubleshooting</h1>
<p>If MCAS isn&rsquo;t recieving your logs, this can usually be boiled down to a few things:</p>
<ul>
<li>Network Configuration</li>
<li>Incorrect API Token</li>
<li>Incorrect MCAS Domain or the URL was entered instead of the domain</li>
<li>Not restarting the NSS service after configuring the NSS VM with the MCAS API token &amp; domain</li>
<li>The data source configured in the MCAS portal is not using the named <code>NSS</code> (see the screenshot above).</li>
<li>Patience</li>
</ul>
<p>Keep in mind that logs will not show in MCAS immediately: These are sent by NSS every hour, but you can verify that NSS is uploading them correctly. Also, MCAS can take a while to process them once they&rsquo;ve been received.</p>
<h2 id="verify-network-connectivity-to-mcas">Verify Network Connectivity to MCAS</h2>
<p>From the NSS VM, check you can check connectivity to MCAS by telnetting to your MCAS domain on port 443:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ telnet oblivioninc.us3.portal.cloudappsecurity.com 443
Trying 40.90.218.198...
Connected to m365x855557.us3.portal.cloudappsecurity.com.
Escape character is &#39;^]&#39;.
</code></pre><p>This will confirm whether you can resolve and reach where the logs will be submitted to.</p>
<h2 id="verify-your-api-token-and-domain-are-correct">Verify your API token and domain are correct</h2>
<p>You can use cURL to check whether both of these are valid or not. Run the following command on your own machine (don&rsquo;t run this on the NSS VM) - substitute the token and URL for your own:</p>
<pre tabindex="0"><code>curl -v &#34;https://oblivioninc.us3.portal.cloudappsecurity.com/api/discovery_block_scripts/?format=120&amp;type=banned&#34; -H &#34;Authorization: Token QhwZGlcXGhoxxxxxx[snip]xxxxxxxGxoW&#34;
</code></pre><p>If both your token and domain are valid, this command will return a list of your unsanctioned applications in MCAS:</p>
<pre tabindex="0"><code>*   Trying 40.90.218.198...
* Connected to oblivioninc.us3.portal.cloudappsecurity.com (40.90.218.198) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
[snip]
*  SSL certificate verify ok.
&gt; GET /api/discovery_block_scripts/?format=120&amp;type=banned HTTP/1.1
&gt; Host: oblivioninc.us3.portal.cloudappsecurity.com
&gt; Authorization: Token QhwZGlxxxxxxxxxxx[snip]xxxxxxxxxxxxxxxxxxxxxx
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Server: nginx
&lt; Date: Wed, 01 Jul 2020 10:59:56 GMT
&lt; Content-Type: text/plain
&lt; Transfer-Encoding: chunked
[snip]
&lt; strict-transport-security: max-age=31536000
&lt; x-content-type-options: nosniff
&lt;
.reddit.com
.redd.it
.redditmedia.com
</code></pre><h2 id="verify-your-api-token-and-mcas-domain-were-entered-correctly-in-the-nss-vm">Verify your API token and MCAS domain were entered correctly in the NSS VM</h2>
<p>Your MCAS API token and domain are stored in the <code>/sc/conf/zbridge-mcas.properties</code> file. Verify you entered them correctly:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ cat /sc/conf/zbridge-mcas.properties

# Authentication token for uploading the traffic logs
token=QhwZGlcxxxxxxxxxxxx[redacted]xxxxxxxxxxxxxx
# MCAS domain like mycompany.portal.cloudappsecurity.com
domain=oblivioninc.us3.portal.cloudappsecurity.com

# Data source name
inputStream=NSS

# Number of transactions in one batch
#batchSize=100000

# Flush interval of the batch in seconds
#flushInterval=3600
</code></pre><p>Ensure the <code>token</code> field accurately contains your MCAS API token.</p>
<p>Ensure the domain field is correct and includes the domain only! If you see <code>http://</code> or <code>https://</code> or any trailing <code>/</code>, you&rsquo;ve entered it incorrectly.</p>
<p>If you need to fix anything up, run the <code>nss configure-mcas</code> command again. Don&rsquo;t forget to restart the NSS service afterward (<code>nss restart</code>).</p>
<h2 id="restart-the-nss-service">Restart the NSS Service</h2>
<p>After any change, you should restart the NSS service:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ sudo nss restart
</code></pre><h2 id="turn-on-debug-logging">Turn on DEBUG logging</h2>
<p>By default, <code>zbridge.log</code> will only log <code>INFO</code> and higher. You can turn on <code>DEBUG</code> logging by editing the <code>/sc/conf/zbridge-log4j.properties</code> file as follows:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ vi /sc/conf/zbridge-mcas.properties

log4j.rootLogger=INFO,FILE         # Change INFO to DEBUG
log4j.logger.kafka=INFO,FILE       # Change INFO to DEBUG

log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=[%d] %p %m (%c)%n

log4j.appender.FILE=org.apache.log4j.RollingFileAppender
log4j.appender.FILE.File=/sc/log/zbridge.log
log4j.appender.FILE.layout=org.apache.log4j.PatternLayout
log4j.appender.FILE.layout.ConversionPattern=[%d] %p %m (%c)%n
log4j.appender.FILE.MaxFileSize=1024MB
log4j.appender.FILE.MaxBackupIndex=7


# Turn on all our debugging info - UNCOMMENT THESE!
#log4j.logger.kafka.producer.async.DefaultEventHandler=DEBUG,stdout
#log4j.logger.kafka.consumer.PartitionTopicInfo=TRACE,stdout
#log4j.logger.kafka.request.logger=TRACE,fileAppender
#log4j.additivity.kafka.request.logger=false
#log4j.logger.kafka.network.Processor=TRACE,fileAppender
#log4j.additivity.kafka.network.Processor=false
#log4j.logger.org.I0Itec.zkclient.ZkClient=DEBUG
</code></pre><p>Edit the file as per the comments: For the first two lines, change <code>INFO</code> to <code>DEBUG</code>, then uncomment the last 7 lines. Restart the NSS service when you are done and check the <code>zbridge.log</code> file:</p>
<pre tabindex="0"><code>[zsroot@NSS ~]$ tail -f /sc/log/zbridge.log

[2020-07-01 14:16:16,962] INFO Upload Response: Created (com.zscaler.bridge.proxy.ProxyConfig)
[2020-07-01 14:16:16,962] INFO Finalize Upload (com.zscaler.bridge.proxy.ProxyConfig)
[2020-07-01 14:16:16,963] DEBUG CookieSpec selected: best-match (org.apache.http.client.protocol.RequestAddCookies)
[2020-07-01 14:16:16,963] DEBUG Cookie [version: 0][name: cas_sessionid][value: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx][domain: .us3.portal.cloudappsecurity.com][path: /][expiry: Wed Jul 01 15:16:13 IST 2020] match [(secure)oblivioninc.us3.portal.cloudappsecurity.com:443/api/v1/discovery/done_upload] (org.apache.http.client.protocol.RequestAddCookies)
[2020-07-01 14:16:16,963] DEBUG Auth cache not set in the context (org.apache.http.client.protocol.RequestAuthCache)
[2020-07-01 14:16:16,963] DEBUG Connection request: [route: {s}-&gt;https://oblivioninc.us3.portal.cloudappsecurity.com:443][total kept alive: 2; route allocated: 1 of 20; total allocated: 2 of 200] (org.apache.http.impl.conn.PoolingHttpClientConnectionManager)
[2020-07-01 14:16:16,963] DEBUG Connection leased: [id: 5][route: {s}-&gt;https://oblivioninc.us3.portal.cloudappsecurity.com:443][total kept alive: 1; route allocated: 1 of 20; total allocated: 2 of 200] (org.apache.http.impl.conn.PoolingHttpClientConnectionManager)
</code></pre><p>The log file will now be very noisy but may help.</p>
<h2 id="check-the-mcas-data-source-is-correctly-named">Check the MCAS data source is correctly named</h2>
<p>When configuring a new data source in MCAS (Settings &gt; Log collectors) to accept data from NSS, it must be named <code>NSS</code> EXACTLY. Naming the feed anything different will result in MCAS dropping the logs it receives from NSS.</p>
<p><img src="17.png" alt="17"></p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://nathancatania.com/tags/mcas">mcas</a></span><span class="tag"><a href="https://nathancatania.com/tags/zscaler">zscaler</a></span><span class="tag"><a href="https://nathancatania.com/tags/zia">zia</a></span><span class="tag"><a href="https://nathancatania.com/tags/lab">lab</a></span><span class="tag"><a href="https://nathancatania.com/tags/notes">notes</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2225 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-07-02</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h">Read other posts</span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://nathancatania.com/posts/integrate-zia-with-azure-sentinel/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Integrate Zscaler with Azure Sentinel</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://nathancatania.com/posts/deploy-zscaler-nss-in-azure/">
                                <span class="button__text">Deploy Zscaler NSS in Azure</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2024</span>
            
                <span><a href="https://nathancatania.com">Nathan Catania</a></span>
            
            <span> <a href="https://nathancatania.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span><a href="https://github.com/nathancatania/website">Source</a></span>
            <span><a href="https://github.com/rhazdon">Theme</a></span>
        </div>
    </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.858712b4b19060b33e6a3b52df9749f413894a75772f4d0b4683380c0ce08c6f93623d63068ef5ae4719980bcaa15ad536694c42897b88c4826c6ece21918827.js" integrity="sha512-hYcStLGQYLM&#43;ajtS35dJ9BOJSnV3L00LRoM4DAzgjG&#43;TYj1jBo71rkcZmAvKoVrVNmlMQol7iMSCbG7OIZGIJw=="></script>




    </body>
</html>
